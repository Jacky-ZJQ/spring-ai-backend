name: spring-ai-stack

services:
  backend:
    build:
      context: .
      dockerfile: Dockerfile
    image: spring-ai-backend:latest
    container_name: spring-ai-backend
    restart: unless-stopped
    environment:
      SERVER_PORT: 8080
      APP_LOG_LEVEL: ${APP_LOG_LEVEL:-info}
      DB_URL: ${DB_URL:?DB_URL is required}
      DB_USERNAME: ${DB_USERNAME:?DB_USERNAME is required}
      DB_PASSWORD: ${DB_PASSWORD:?DB_PASSWORD is required}
      OPENAI_API_KEY: ${OPENAI_API_KEY:?OPENAI_API_KEY is required}
      OPENAI_BASE_URL: ${OPENAI_BASE_URL:-https://dashscope.aliyuncs.com/compatible-mode}
      OPENAI_CHAT_MODEL: ${OPENAI_CHAT_MODEL:-qwen-max-latest}
      OPENAI_EMBEDDING_MODEL: ${OPENAI_EMBEDDING_MODEL:-text-embedding-v3}
      OLLAMA_BASE_URL: ${OLLAMA_BASE_URL:-http://host.docker.internal:11434}
      OLLAMA_CHAT_MODEL: ${OLLAMA_CHAT_MODEL:-deepseek-r1:1.5b}
      SKILL_GENERAL_CLIENT_BEAN: ${SKILL_GENERAL_CLIENT_BEAN:-ollamaChatClient}
      SKILLS_ENABLED: ${SKILLS_ENABLED:-true}
      MCP_ENABLED: ${MCP_ENABLED:-true}
      MCP_SERVER_NAME: ${MCP_SERVER_NAME:-spring-ai-mcp-gateway}
      MCP_SERVER_VERSION: ${MCP_SERVER_VERSION:-1.0.0}
      MCP_SESSION_TTL_SECONDS: ${MCP_SESSION_TTL_SECONDS:-1800}
      MCP_AUTO_REGISTER_UNCONFIGURED_TOOLS: ${MCP_AUTO_REGISTER_UNCONFIGURED_TOOLS:-true}
    ports:
      - "${BACKEND_PORT:-8080}:8080"
    mem_limit: 2048m
    cpus: "1.5"
    extra_hosts:
      - "host.docker.internal:host-gateway"
    networks:
      - spring-ai-net

  portal:
    build:
      context: ../spring-ai-protal
      dockerfile: Dockerfile
      args:
        VITE_API_BASE_URL: ${VITE_API_BASE_URL:-/api}
    image: spring-ai-portal:latest
    container_name: spring-ai-portal
    restart: unless-stopped
    depends_on:
      - backend
    ports:
      - "${PORTAL_PORT:-80}:80"
    mem_limit: 512m
    cpus: "0.5"
    networks:
      - spring-ai-net

networks:
  spring-ai-net:
    driver: bridge
